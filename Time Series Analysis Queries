-- View table to ensure data was imported --
SELECT * FROM retail_sales

-- Viewing trends of Retail/food service sales over time --
SELECT sales_month, sales
FROM retail_sales
WHERE kind_of_business = 'Retail and food services sales, total';
- The graph facet shows the overall tripling of sales over 28 years

-- Graph shows some extra "noise". To remediate this we will dilute the graph to show only years --
SELECT date_part('year',sales_month) as sales_year
,sum(sales) as sales
FROM retail_sales
WHERE kind_of_business = 'Retail and food services sales, total'
GROUP BY 1
ORDER BY 1
;

-- Comparing book store, toy store, and sporting goods stores sales over the years --
SELECT date_part('year',sales_month) as sales_year
,kind_of_business
,sum(sales) as sales
FROM retail_sales
WHERE kind_of_business in ('Book stores','sporting goods stores', 'Hobby, toy, and game stores')
GROUP BY 1,2
ORDER BY 1,2
;

-- Comparing trends of sales for men's and women's clothing stores --
SELECT sales_month, kind_of_business, sales
FROM retail_sales
WHERE kind_of_business in ('Men''s clothing stores', 'Women''s clothing stores')
ORDER BY 1,2
;

-- Aggregating the previous results for less 'noise' on the graph --
SELECT date_part('year',sales_month) as sales_year, kind_of_business, sum(sales) as sales
FROM retail_sales
WHERE kind_of_business in ('Men''s clothing stores', 'Women''s clothing stores')
GROUP BY 1,2
;

-- Separating Men's and women's into different columns and organizing by month
SELECT date_part('year',sales_month) as sales_year, 
sum(case when kind_of_business = 'Women''s clothing stores' then sales end) as womens_sales,
sum(case when kind_of_business = 'Men''s clothing stores' then sales end) as mens_sales
FROM retail_sales
WHERE kind_of_business in ('Men''s clothing stores', 'Women''s clothing stores')
GROUP BY 1
ORDER BY 1
;

-- Calculating the difference of sales between men's and women's clothing sales --
SELECT sales_year
,womens_sales - mens_sales as womens_minus_mens
,mens_sales - womens_sales as mens_minus_womens
FROM
(
        SELECT date_part('year',sales_month) as sales_year
        ,sum(case when kind_of_business = 'Women''s clothing stores' then sales end) as womens_sales
        ,sum(case when kind_of_business = 'Men''s clothing stores' then sales end) as mens_sales
        FROM retail_sales
        WHERE kind_of_business in ('Men''s clothing stores','Women''s clothing stores')
        and sales_month <= '2019-12-01'
        GROUP BY 1
) a
ORDER BY 1
;

-- Moving the difference between the two values to one column --
SELECT date_part('year',sales_month) as sales_year
, sum(case when kind_of_business = 'Women''s clothing stores' then sales end) 
 - sum(case when kind_of_business = 'Men''s clothing stores' then sales end) as womens_minus_mens
FROM retail_sales
WHERE kind_of_business in ('Men''s clothing stores'
 , 'Women''s clothing stores')
and sales_month <= '2019-12-01'
GROUP BY 1
ORDER BY 1
;

-- Calculation of Total sales in percentages of Men's and Women's clothing per month/year --
SELECT sales_month ,kind_of_business ,sales * 100 / total_sales as pct_total_sales
FROM
(
        SELECT a.sales_month
        ,a.kind_of_business
        ,a.sales
        ,sum(b.sales) as total_sales
        FROM retail_sales a
        JOIN retail_sales b on a.sales_month = b.sales_month
        and b.kind_of_business in ('Men''s clothing stores'
         , 'Women''s clothing stores')
        WHERE a.kind_of_business in ('Men''s clothing stores', 'Women''s clothing stores')
        GROUP BY 1,2,3
) aa
ORDER BY 1,2
;

-- Calculation of yearly sales percentage that Men's and Women's clothing make up --
SELECT sales_month
,kind_of_business
,sales * 100 / yearly_sales as pct_yearly
FROM
(
        SELECT a.sales_month
        ,a.kind_of_business
        ,a.sales
        ,sum(b.sales) as yearly_sales
        FROM retail_sales a
        JOIN retail_sales b on date_part('year',a.sales_month) = date_part('year',b.sales_month)
        and a.kind_of_business = b.kind_of_business
        and b.kind_of_business in ('Men''s clothing stores','Women''s clothing stores')
        WHERE a.kind_of_business in ('Men''s clothing stores','Women''s clothing stores')
        GROUP BY 1,2,3
) aa
ORDER BY 1,2
;

-- 
